<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Console - Shakil Sayed</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"> <!-- Font Awesome for icons -->
    <style>
 body {
            font-family: 'Poppins', sans-serif;
            background: #1e3799; /* A deep blue background color */
            color: #fff;
            display: flex;
            flex-direction: column;
            justify-content: center; /* Center content vertically and horizontally */
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow-x: hidden; /* Hide horizontal scrollbar */
        }
        .container {
            text-align: center;
            background-color: rgba(0, 0, 0, 0.6); /* A semi-transparent black background for the container */
            padding: 20px;
            border-radius: 10px;
            margin-left: 20px; /* Add margin to accommodate the sidebar */
            z-index: 0; /* Set the z-index to 0 to ensure it's below the sidebar */
            margin-top: 180px;
            gap: 10px;
        }
        h1 {
            font-size: 32px;
        }
        input[type="date"] {
            padding: 10px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
        }
        input[type="date"]::before {
            content: "ðŸ“…"; /* A calendar icon before the date input */
            margin-right: 5px;
        }
        .close-icon {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            font-size: 24px;
            color: #fff;
        }
        .button-30 {
            background: #4CAF50; /* Green */
            border: none;
            padding: 10px 20px;
            color: #FFFFFF;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 0; /* Remove the negative margin */
            margin-left: 0; /* Align the button next to the input */
            margin-top: 10px;
        }
        .button-30:hover {
            background-color: #45a049;
        }

        .date-button-container {
    display: flex; /* This will only apply flex to the container of the date picker and button */
    align-items: center; /* This will vertically center the button and date picker */
    justify-content: center; /* This will horizontally center the button and date picker on the page */
    gap: 10px; /* Adjust the space between the date picker and the button */
}

        .navbar {
            background-color: #1e3799; /* Dark blue background color for the navbar */
            width: 100%;
            position: fixed;
            top: 0;
            z-index: 1;
        }
        .navbar-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
        }
        .navbar-logo {
            font-size: 24px;
            color: #fff;
            text-decoration: none;
        }
        .navbar-links {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
        }
        .nav-link {
            margin-right: 20px;
            text-decoration: none;
            color: #fff;
            font-weight: bold;
            transition: color 0.3s ease;
        }
        .nav-link:hover {
            color: #45a049; /* Green color on hover */
        }
        .container {
            text-align: center;
            background-color: rgba(0, 0, 0, 0.6); /* A semi-transparent black background for the container */
            padding: 20px;
            border-radius: 10px;
            margin-top: -60px; /* Adjusted top margin to accommodate the navbar */
            gap: 10px;
        }
        h1 {
            font-size: 32px;
        }
        
/* Modal Styles */
.modal {
    display: none; 
    position: fixed; 
    z-index: 2; 
    left: 0; 
    top: 0; 
    width: 100%; 
    height: 100%; 
    overflow: auto; 
    background-color: rgba(0, 0, 0, 0.4); 
    align-items: center;
    justify-content: center;
    display: flex;
}

.modal-content {
    background-color:#333; 
    margin: auto; 
    padding: 20px; 
    border-radius: 8px; 
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    width: 25%;
    min-width: 300px;
    text-align: center;
}

.close {
    color: #888; 
    float: right; 
    font-size: 24px; 
    font-weight: bold; 
    cursor: pointer;
}

.close:hover,
.close:focus {
    color: #444;
    text-decoration: none;
    cursor: pointer;
}

/* Dropdown Styles */
select {
    width: 80%; 
    padding: 8px 16px; 
    margin-top: 10px;
    margin-bottom: 20px;
    border: 1px solid #ddd; 
    border-radius: 4px; 
    font-size: 16px; 
    color: #333;
    background-color: #fff;
    box-sizing: border-box;
    cursor: pointer;
}

/* Button Styles */
button {
    background-color: #4CAF50; 
    color: white; 
    padding: 10px 20px; 
    margin: 10px 0; 
    border: none; 
    border-radius: 4px; 
    cursor: pointer; 
    font-size: 16px;
}

button:hover {
    background-color: #45a049;
}
    </style>
</head>
<body>

    <!-- Navigation Bar -->
<div class="navbar">
    <div class="navbar-content">
        <a href="#" class="navbar-logo">Admin Console</a>
        <ul class="navbar-links">
            <li><a href="index.html" class="nav-link">PR Logger</a></li>
            <li><a href="admin.html" class="nav-link">Admin Report Console</a></li>
        </ul>
    </div>
</div>

<!-- Main Content -->
<div class="container">
    <h1>Welcome to the Admin Report Console</h1>
    <p>Select a date to download the report:</p>
    <div class="date-button-container">
        <input type="date" id="filterDate" placeholder="Filter by Date">
        <button class="button-30" role="button" id="downloadExcel">Download Report</button>
    </div>
</div>

<!-- Modal for Department Selection -->
<div id="departmentModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close" id="closeModal">&times;</span>
        <h2>Select Department</h2>
        <select id="departmentFilter">
            <option value="all">All Departments</option>
            <!-- Add options for each department here -->
                    <option value="Pathways">Pathways</option>
					<option value="Oxford Direct - Ravensbourne">Oxford Direct - Ravensbourne</option>
                    <option value="Oxford Direct - BPP">Oxford Direct - BPP</option>
                    <option value="Oxford Direct - Roehampton">Oxford Direct - Roehampton</option>
        </select>
        <button id="triggerDownload">Download Report</button>
    </div>
</div>

<!-- JavaScript to control the report download -->
<script>
document.getElementById('downloadExcel').addEventListener('click', function() {
    var reportDate = document.getElementById('filterDate').value;
    if (!reportDate) {
        alert('Please select a date for the report.');
        return;
    }
    document.getElementById('departmentModal').style.display = 'block';
});

document.getElementById('closeModal').addEventListener('click', function() {
    document.getElementById('departmentModal').style.display = 'none';
});

document.getElementById('triggerDownload').addEventListener('click', function() {
    document.getElementById('departmentModal').style.display = 'none';
    var reportDate = document.getElementById('filterDate').value;
    var selectedDepartment = document.getElementById('departmentFilter').value;

    // Replace these with your actual API key and sheet ID
    const apiKey = 'AIzaSyAWVybWDvIA9Xiic2z3uoat4V1ymFshW7s'; // Replace with your actual API key
    const sheetId = '1gcsBvEoHAhlhM0WWIXpF5TbfRua-wWWqL7ykySy9fDk'; // Replace with your actual sheet ID
    const range = 'A:Z';

    fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${range}?key=${apiKey}`)
        .then(response => response.json())
        .then(data => {
            const headers = data.values[0];
            const rows = data.values.slice(1);
            let reportData = {};
            let rawSheetData = [];

            rows.forEach(row => {
                const taskDate = row[headers.indexOf('Task Date')];
                const workingDepartment = row[headers.indexOf('Working Department')];

                if (taskDate === reportDate && (selectedDepartment === 'all' || workingDepartment === selectedDepartment)) {
                    rawSheetData.push(row);

                    const agentName = row[headers.indexOf('Agent Name')];
                    const workingRegion = row[headers.indexOf('Working Region')];
                    const taskTime = row[headers.indexOf('Task Time')];

                    let [hours, minutes] = taskTime.split(':').map(n => parseInt(n, 10));
                    let totalMinutes = hours * 60 + minutes;

                    if (!reportData[agentName]) {
                        reportData[agentName] = {
                            'Working Department': workingDepartment,
                            'Working Region': workingRegion,
                            'Total Task Time': 0,
                            'Submission Count': 0
                        };
                    }
                    reportData[agentName]['Total Task Time'] += totalMinutes;
                    reportData[agentName]['Submission Count'] += 1;
                }
            });

            let reportArray = Object.keys(reportData).map(agentName => {
                const totalMinutes = reportData[agentName]['Total Task Time'];
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                const formattedTime = `${hours}h ${minutes}m`;

                return {
                    'Agent Name': agentName,
                    'Working Department': reportData[agentName]['Working Department'],
                    'Working Region': reportData[agentName]['Working Region'],
                    'Total Task Time': formattedTime,
                    'Submission Count': reportData[agentName]['Submission Count'],
                    'Date': reportDate
                };
            });

            let filteredReportArray = selectedDepartment === 'all'
                ? reportArray
                : reportArray.filter(row => row['Working Department'] === selectedDepartment);

            if (filteredReportArray.length === 0) {
                alert('No data found for the selected date and/or department.');
                return;
            }

            createSheetsAndDownload(filteredReportArray, rawSheetData, headers, reportDate);
        })
        .catch(error => {
            console.error('Error fetching data:', error);
        });
});

function createSheetsAndDownload(reportArray, rawSheetData, headers, reportDate) {
    let worksheet1 = XLSX.utils.json_to_sheet(reportArray);
    let workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet1, 'Summary Report');

    rawSheetData.unshift(headers);
    let worksheet2 = XLSX.utils.aoa_to_sheet(rawSheetData);
    XLSX.utils.book_append_sheet(workbook, worksheet2, 'Raw Data');

    XLSX.writeFile(workbook, `Report_${reportDate}.xlsx`);
}
</script>
</body>
</html>
